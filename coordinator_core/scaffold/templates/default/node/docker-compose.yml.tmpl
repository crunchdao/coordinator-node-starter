services:
  postgres:
    image: postgres:15
    container_name: [[node_name]]-postgres
    restart: always
    ports:
      - "5432:5432"
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-starter}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-starter}
      POSTGRES_DB: ${POSTGRES_DB:-starter}
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d ${POSTGRES_DB:-starter} -U ${POSTGRES_USER:-starter}"]
      interval: 2s
      timeout: 5s
      retries: 20
      start_period: 10s
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks: [coordinator-net]

  init-db:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: [[node_name]]-init-db
    command: ["python", "-m", "node_template.infrastructure.db.init_db"]
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-starter}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-starter}
      POSTGRES_DB: ${POSTGRES_DB:-starter}
      SCHEDULED_PREDICTION_CONFIGS_PATH: /app/config/scheduled_prediction_configs.json
    volumes:
      - ./config/scheduled_prediction_configs.json:/app/config/scheduled_prediction_configs.json:ro
    depends_on:
      postgres:
        condition: service_healthy
    networks: [coordinator-net]

  market-data-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: [[node_name]]-market-data-worker
    restart: always
    command: ["python", "-m", "node_template.workers.market_data_worker"]
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-starter}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-starter}
      POSTGRES_DB: ${POSTGRES_DB:-starter}
      FEED_PROVIDER: ${FEED_PROVIDER:-pyth}
      FEED_ASSETS: ${FEED_ASSETS:-BTC}
      FEED_KIND: ${FEED_KIND:-tick}
      FEED_GRANULARITY: ${FEED_GRANULARITY:-1s}
      FEED_POLL_SECONDS: ${FEED_POLL_SECONDS:-5}
      FEED_BACKFILL_MINUTES: ${FEED_BACKFILL_MINUTES:-180}
      MARKET_RECORD_TTL_DAYS: ${MARKET_RECORD_TTL_DAYS:-90}
      MARKET_RETENTION_CHECK_SECONDS: ${MARKET_RETENTION_CHECK_SECONDS:-3600}
      PYTHONPATH: /app/challenge
    volumes:
      - ../[[challenge_name]]:/app/challenge
    depends_on:
      init-db:
        condition: service_completed_successfully
    networks: [coordinator-net]

  predict-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: [[node_name]]-predict-worker
    restart: always
    command: ["python", "-m", "node_template.workers.predict_worker"]
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-starter}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-starter}
      POSTGRES_DB: ${POSTGRES_DB:-starter}
      MODEL_RUNNER_NODE_HOST: ${MODEL_RUNNER_NODE_HOST:-model-orchestrator}
      MODEL_RUNNER_NODE_PORT: ${MODEL_RUNNER_NODE_PORT:-9091}
      MODEL_RUNNER_TIMEOUT_SECONDS: ${MODEL_RUNNER_TIMEOUT_SECONDS:-60}
      CHECKPOINT_INTERVAL_SECONDS: ${CHECKPOINT_INTERVAL_SECONDS:-60}
      CRUNCH_ID: ${CRUNCH_ID:-starter-challenge}
      MODEL_BASE_CLASSNAME: ${MODEL_BASE_CLASSNAME:-tracker.TrackerBase}
      FEED_PROVIDER: ${FEED_PROVIDER:-pyth}
      FEED_ASSETS: ${FEED_ASSETS:-BTC}
      FEED_KIND: ${FEED_KIND:-tick}
      FEED_GRANULARITY: ${FEED_GRANULARITY:-1s}
      INFERENCE_INPUT_BUILDER: ${INFERENCE_INPUT_BUILDER}
      INFERENCE_OUTPUT_VALIDATOR: ${INFERENCE_OUTPUT_VALIDATOR}
      RAW_INPUT_PROVIDER: ${RAW_INPUT_PROVIDER}
      PREDICTION_SCOPE_BUILDER: ${PREDICTION_SCOPE_BUILDER}
      PREDICT_CALL_BUILDER: ${PREDICT_CALL_BUILDER}
      PYTHONPATH: /app/challenge
    volumes:
      - ../[[challenge_name]]:/app/challenge
    depends_on:
      init-db:
        condition: service_completed_successfully
      model-orchestrator:
        condition: service_started
      market-data-worker:
        condition: service_started
    networks: [coordinator-net]

  score-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: [[node_name]]-score-worker
    restart: always
    command: ["python", "-m", "node_template.workers.score_worker"]
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-starter}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-starter}
      POSTGRES_DB: ${POSTGRES_DB:-starter}
      CHECKPOINT_INTERVAL_SECONDS: ${CHECKPOINT_INTERVAL_SECONDS:-60}
      FEED_PROVIDER: ${FEED_PROVIDER:-pyth}
      FEED_ASSETS: ${FEED_ASSETS:-BTC}
      FEED_KIND: ${FEED_KIND:-tick}
      FEED_GRANULARITY: ${FEED_GRANULARITY:-1s}
      SCORING_FUNCTION: ${SCORING_FUNCTION}
      MODEL_SCORE_AGGREGATOR: ${MODEL_SCORE_AGGREGATOR}
      LEADERBOARD_RANKER: ${LEADERBOARD_RANKER}
      GROUND_TRUTH_RESOLVER: ${GROUND_TRUTH_RESOLVER}
      PYTHONPATH: /app/challenge
    volumes:
      - ../[[challenge_name]]:/app/challenge
    depends_on:
      init-db:
        condition: service_completed_successfully
      market-data-worker:
        condition: service_started
    networks: [coordinator-net]

  report-worker:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: [[node_name]]-report-worker
    restart: always
    command: ["python", "-m", "node_template.workers.report_worker"]
    ports:
      - "8000:8000"
    environment:
      POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
      POSTGRES_PORT: ${POSTGRES_PORT:-5432}
      POSTGRES_USER: ${POSTGRES_USER:-starter}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-starter}
      POSTGRES_DB: ${POSTGRES_DB:-starter}
      REPORT_SCHEMA_PROVIDER: ${REPORT_SCHEMA_PROVIDER}
      PYTHONPATH: /app/challenge
    volumes:
      - ../[[challenge_name]]:/app/challenge
    depends_on:
      init-db:
        condition: service_completed_successfully
    networks: [coordinator-net]

  model-orchestrator:
    build:
      context: https://github.com/crunchdao/model-orchestrator.git
    container_name: [[node_name]]-model-orchestrator
    restart: unless-stopped
    init: true
    ports:
      - "9091:9091"
    environment:
      DOCKER_NETWORK_NAME: [[node_name]]-net
    volumes:
      - ./deployment/model-orchestrator-local/data:/app/data
      - ./deployment/model-orchestrator-local/config:/app/config
      - /var/run/docker.sock:/var/run/docker.sock
    privileged: true
    entrypoint: ["sh", "/app/config/docker-entrypoint.sh"]
    command:
      [
        "model-orchestrator",
        "dev",
        "--configuration-file",
        "/app/config/orchestrator.dev.yml",
        "--rebuild",
        "if-code-modified",
      ]
    networks: [coordinator-net]

  report-ui:
    build:
      context: ${REPORT_UI_BUILD_CONTEXT:-https://github.com/crunchdao/coordinator-webapp.git}
      dockerfile: ${REPORT_UI_DOCKERFILE:-apps/starter/Dockerfile}
      args:
        NEXT_PUBLIC_API_URL: "http://report-worker:8000"
        NEXT_PUBLIC_API_URL_MODEL_ORCHESTRATOR: "http://model-orchestrator:8001"
    container_name: [[node_name]]-report-ui
    ports:
      - "3000:3000"
    volumes:
      - ./deployment/report-ui/config:/app/config
      - ./deployment/report-ui/config:/app/apps/starter/config
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - report-worker
    networks: [coordinator-net]

networks:
  coordinator-net:
    driver: bridge
    name: [[node_name]]-net

volumes:
  postgres-data:
