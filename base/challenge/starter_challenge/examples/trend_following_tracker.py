from __future__ import annotations

from starter_challenge.tracker import TrackerBase


class TrendFollowingTracker(TrackerBase):
    """Projects recent direction forward with conservative scaling."""

    def predict(self, subject: str, horizon_seconds: int, step_seconds: int) -> dict:
        prices = _extract_prices(getattr(self, "_latest_data", None))
        if len(prices) < 3:
            return {"value": 0.0}

        lookback = min(8, len(prices))
        window = prices[-lookback:]
        momentum = (window[-1] - window[0]) / max(abs(window[0]), 1e-9)

        return {"value": 0.6 * momentum}


def _extract_prices(latest_data):
    if isinstance(latest_data, dict) and isinstance(latest_data.get("candles_1m"), list):
        return _closes(latest_data["candles_1m"])
    return []


def _closes(candles):
    closes = []
    for row in candles:
        if not isinstance(row, dict):
            continue
        value = row.get("close")
        try:
            closes.append(float(value))
        except Exception:
            continue
    return closes
