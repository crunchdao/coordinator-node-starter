x-common-env:
  environment: &common-db-env
    POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
    POSTGRES_PORT: ${POSTGRES_PORT:-5432}
    POSTGRES_USER: ${POSTGRES_USER:-starter}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-starter}
    POSTGRES_DB: ${POSTGRES_DB:-starter}

x-common-build: &common-build
  build:
    context: .
    dockerfile: Dockerfile

services:
  postgres:
    image: postgres:15
    environment: *common-db-env
    container_name: coordinator-starter-postgres
    restart: always
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d ${POSTGRES_DB:-starter} -U ${POSTGRES_USER:-starter}"]
      interval: 2s
      timeout: 5s
      retries: 20
      start_period: 10s
    volumes:
      - ./data/postgres_data:/var/lib/postgresql/data
    networks: [coordinator-net]

  init-db:
    <<: *common-build
    environment:
      <<: *common-db-env
      SCHEDULED_PREDICTION_CONFIGS_PATH: ${SCHEDULED_PREDICTION_CONFIGS_PATH:-}
    command: ["python", "-m", "coordinator_node.db.init_db"]
    depends_on:
      postgres:
        condition: service_healthy
    networks: [coordinator-net]

  feed-data-worker:
    <<: *common-build
    environment:
      <<: *common-db-env
      FEED_SOURCE: ${FEED_SOURCE:-pyth}
      FEED_SUBJECTS: ${FEED_SUBJECTS:-BTC}
      FEED_KIND: ${FEED_KIND:-tick}
      FEED_GRANULARITY: ${FEED_GRANULARITY:-1s}
      FEED_POLL_SECONDS: ${FEED_POLL_SECONDS:-5}
      FEED_BACKFILL_MINUTES: ${FEED_BACKFILL_MINUTES:-180}
      FEED_RECORD_TTL_DAYS: ${FEED_RECORD_TTL_DAYS:-90}
      FEED_RETENTION_CHECK_SECONDS: ${FEED_RETENTION_CHECK_SECONDS:-3600}
    restart: always
    command: ["python", "-m", "coordinator_node.workers.feed_data_worker"]
    depends_on:
      init-db:
        condition: service_completed_successfully
    networks: [coordinator-net]

  predict-worker:
    <<: *common-build
    environment:
      <<: *common-db-env
      MODEL_RUNNER_NODE_HOST: ${MODEL_RUNNER_NODE_HOST:-model-orchestrator}
      MODEL_RUNNER_NODE_PORT: ${MODEL_RUNNER_NODE_PORT:-9091}
      MODEL_RUNNER_TIMEOUT_SECONDS: ${MODEL_RUNNER_TIMEOUT_SECONDS:-60}
      CHECKPOINT_INTERVAL_SECONDS: ${CHECKPOINT_INTERVAL_SECONDS:-60}
      CRUNCH_ID: ${CRUNCH_ID:-starter-challenge}
      MODEL_BASE_CLASSNAME: ${MODEL_BASE_CLASSNAME:-tracker.TrackerBase}
      FEED_SOURCE: ${FEED_SOURCE:-pyth}
      FEED_SUBJECTS: ${FEED_SUBJECTS:-BTC}
      FEED_KIND: ${FEED_KIND:-tick}
      FEED_GRANULARITY: ${FEED_GRANULARITY:-1s}
      SCORING_FUNCTION: ${SCORING_FUNCTION:-coordinator_node.extensions.default_callables:default_score_prediction}
    restart: always
    command: ["python", "-m", "coordinator_node.workers.predict_worker"]
    depends_on:
      init-db:
        condition: service_completed_successfully
      feed-data-worker:
        condition: service_started
    networks: [coordinator-net]

  score-worker:
    <<: *common-build
    environment:
      <<: *common-db-env
      CHECKPOINT_INTERVAL_SECONDS: ${CHECKPOINT_INTERVAL_SECONDS:-60}
      FEED_SOURCE: ${FEED_SOURCE:-pyth}
      FEED_SUBJECTS: ${FEED_SUBJECTS:-BTC}
      FEED_KIND: ${FEED_KIND:-tick}
      FEED_GRANULARITY: ${FEED_GRANULARITY:-1s}
      SCORING_FUNCTION: ${SCORING_FUNCTION:-coordinator_node.extensions.default_callables:default_score_prediction}
    restart: always
    command: ["python", "-m", "coordinator_node.workers.score_worker"]
    depends_on:
      init-db:
        condition: service_completed_successfully
      feed-data-worker:
        condition: service_started
    networks: [coordinator-net]

  checkpoint-worker:
    <<: *common-build
    environment:
      <<: *common-db-env
      CHECKPOINT_INTERVAL_SECONDS: ${CHECKPOINT_INTERVAL_SECONDS:-604800}
    restart: always
    command: ["python", "-m", "coordinator_node.workers.checkpoint_worker"]
    depends_on:
      init-db:
        condition: service_completed_successfully
    networks: [coordinator-net]

  report-worker:
    <<: *common-build
    environment:
      <<: *common-db-env
      BACKFILL_DATA_DIR: ${BACKFILL_DATA_DIR:-/app/data/backfill}
    restart: always
    command: ["python", "-m", "coordinator_node.workers.report_worker"]
    ports:
      - "8000:8000"
    volumes:
      - ./data/backfill:/app/data/backfill
    depends_on:
      init-db:
        condition: service_completed_successfully
    networks: [coordinator-net]

  report-ui:
    build:
      context: ${REPORT_UI_BUILD_CONTEXT:-https://github.com/crunchdao/coordinator-webapp.git}
      dockerfile: ${REPORT_UI_DOCKERFILE:-apps/starter/Dockerfile}
      args:
        NEXT_PUBLIC_API_URL: "${NEXT_PUBLIC_API_URL:-http://report-worker:8000}"
        NEXT_PUBLIC_API_URL_MODEL_ORCHESTRATOR: "${NEXT_PUBLIC_API_URL_MODEL_ORCHESTRATOR:-http://model-orchestrator:8001}"
    container_name: coordinator-starter-report-ui
    restart: always
    ports:
      - "3000:3000"
    depends_on:
      - report-worker
    networks: [coordinator-net]

networks:
  coordinator-net:
    driver: bridge
    name: coordinator-starter-net
