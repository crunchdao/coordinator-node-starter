name: crunch-node-${CRUNCH_ID:-starter}

x-common-env:
  environment: &common-db-env
    POSTGRES_HOST: ${POSTGRES_HOST:-postgres}
    POSTGRES_PORT: ${POSTGRES_PORT:-5432}
    POSTGRES_USER: ${POSTGRES_USER:-starter}
    POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-starter}
    POSTGRES_DB: ${POSTGRES_DB:-starter}

x-common-build: &common-build
  build:
    context: .
    dockerfile: Dockerfile
  deploy:
    resources:
      limits:
        memory: 512M
      reservations:
        memory: 256M

services:
  postgres:
    image: postgres:15-alpine
    container_name: crunch-node-${CRUNCH_ID:-starter}-postgres
    environment: *common-db-env
    restart: always
    expose:
      - "5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -d ${POSTGRES_DB:-starter} -U ${POSTGRES_USER:-starter}"]
      interval: 2s
      timeout: 5s
      retries: 20
      start_period: 10s
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks: [backend]
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  init-db:
    <<: *common-build
    container_name: crunch-node-${CRUNCH_ID:-starter}-init-db
    environment:
      <<: *common-db-env
      PYTHONUNBUFFERED: "1"
      SCHEDULED_PREDICTION_CONFIGS_PATH: ${SCHEDULED_PREDICTION_CONFIGS_PATH:-}
    stdin_open: false
    tty: false
    command: ["python", "-m", "coordinator_node.db.init_db"]
    depends_on:
      postgres:
        condition: service_healthy
    networks: [backend]

  reset-db:
    <<: *common-build
    container_name: crunch-node-${CRUNCH_ID:-starter}-reset-db
    environment:
      <<: *common-db-env
      PYTHONUNBUFFERED: "1"
      SCHEDULED_PREDICTION_CONFIGS_PATH: ${SCHEDULED_PREDICTION_CONFIGS_PATH:-}
    stdin_open: false
    tty: false
    command: ["python", "-m", "coordinator_node.db.init_db", "--reset"]
    profiles: [reset]
    depends_on:
      postgres:
        condition: service_healthy
    networks: [backend]

  feed-data-worker:
    <<: *common-build
    container_name: crunch-node-${CRUNCH_ID:-starter}-feed-data-worker
    healthcheck:
      disable: true
    environment:
      <<: *common-db-env
      FEED_SOURCE: ${FEED_SOURCE:-pyth}
      FEED_SUBJECTS: ${FEED_SUBJECTS:-BTC}
      FEED_KIND: ${FEED_KIND:-tick}
      FEED_GRANULARITY: ${FEED_GRANULARITY:-1s}
      FEED_POLL_SECONDS: ${FEED_POLL_SECONDS:-5}
      FEED_BACKFILL_MINUTES: ${FEED_BACKFILL_MINUTES:-180}
      FEED_RECORD_TTL_DAYS: ${FEED_RECORD_TTL_DAYS:-90}
      FEED_RETENTION_CHECK_SECONDS: ${FEED_RETENTION_CHECK_SECONDS:-3600}
    restart: always
    stop_grace_period: 5s
    command: ["python", "-m", "coordinator_node.workers.feed_data_worker"]
    depends_on:
      postgres:
        condition: service_healthy
      init-db:
        condition: service_completed_successfully
    networks: [backend, external]

  predict-worker:
    <<: *common-build
    container_name: crunch-node-${CRUNCH_ID:-starter}-predict-worker
    healthcheck:
      disable: true
    environment:
      <<: *common-db-env
      MODEL_RUNNER_NODE_HOST: ${MODEL_RUNNER_NODE_HOST:-model-orchestrator}
      MODEL_RUNNER_NODE_PORT: ${MODEL_RUNNER_NODE_PORT:-9091}
      MODEL_RUNNER_TIMEOUT_SECONDS: ${MODEL_RUNNER_TIMEOUT_SECONDS:-60}
      CHECKPOINT_INTERVAL_SECONDS: ${CHECKPOINT_INTERVAL_SECONDS:-60}
      CRUNCH_ID: ${CRUNCH_ID:-starter-challenge}
      MODEL_BASE_CLASSNAME: ${MODEL_BASE_CLASSNAME:-tracker.TrackerBase}
      FEED_SOURCE: ${FEED_SOURCE:-pyth}
      FEED_SUBJECTS: ${FEED_SUBJECTS:-BTC}
      FEED_KIND: ${FEED_KIND:-tick}
      FEED_GRANULARITY: ${FEED_GRANULARITY:-1s}
      SCORING_FUNCTION: ${SCORING_FUNCTION:-coordinator_node.extensions.default_callables:default_score_prediction}
    restart: always
    stop_grace_period: 5s
    command: ["python", "-m", "coordinator_node.workers.predict_worker"]
    depends_on:
      postgres:
        condition: service_healthy
      init-db:
        condition: service_completed_successfully
      feed-data-worker:
        condition: service_started
      model-orchestrator:
        condition: service_started
    networks: [backend]

  score-worker:
    <<: *common-build
    container_name: crunch-node-${CRUNCH_ID:-starter}-score-worker
    healthcheck:
      disable: true
    environment:
      <<: *common-db-env
      CHECKPOINT_INTERVAL_SECONDS: ${CHECKPOINT_INTERVAL_SECONDS:-60}
      FEED_SOURCE: ${FEED_SOURCE:-pyth}
      FEED_SUBJECTS: ${FEED_SUBJECTS:-BTC}
      FEED_KIND: ${FEED_KIND:-tick}
      FEED_GRANULARITY: ${FEED_GRANULARITY:-1s}
      SCORING_FUNCTION: ${SCORING_FUNCTION:-coordinator_node.extensions.default_callables:default_score_prediction}
    restart: always
    stop_grace_period: 5s
    command: ["python", "-m", "coordinator_node.workers.score_worker"]
    depends_on:
      postgres:
        condition: service_healthy
      init-db:
        condition: service_completed_successfully
      feed-data-worker:
        condition: service_started
    networks: [backend]

  checkpoint-worker:
    <<: *common-build
    container_name: crunch-node-${CRUNCH_ID:-starter}-checkpoint-worker
    healthcheck:
      disable: true
    environment:
      <<: *common-db-env
      CHECKPOINT_INTERVAL_SECONDS: ${CHECKPOINT_INTERVAL_SECONDS:-604800}
    restart: always
    stop_grace_period: 5s
    command: ["python", "-m", "coordinator_node.workers.checkpoint_worker"]
    depends_on:
      postgres:
        condition: service_healthy
      init-db:
        condition: service_completed_successfully
    networks: [backend]

  report-worker:
    <<: *common-build
    container_name: crunch-node-${CRUNCH_ID:-starter}-report-worker
    environment:
      <<: *common-db-env
      BACKFILL_DATA_DIR: ${BACKFILL_DATA_DIR:-/app/data/backfill}
    restart: always
    stop_grace_period: 5s
    command: ["python", "-m", "coordinator_node.workers.report_worker"]
    ports:
      - "8000:8000"
    volumes:
      - ./data/backfill:/app/data/backfill
    depends_on:
      postgres:
        condition: service_healthy
      init-db:
        condition: service_completed_successfully
    networks: [frontend, backend]

  model-orchestrator:
    build:
      context: ./base/node/deployment/model-orchestrator-local
    container_name: crunch-node-${CRUNCH_ID:-starter}-model-orchestrator
    restart: unless-stopped
    init: true
    stop_grace_period: 5s
    expose:
      - "9091"
    environment:
      DOCKER_NETWORK_NAME: crunch-node-${CRUNCH_ID:-starter}-backend
      DOCKER_COMPOSE_PROJECT: crunch-node-${CRUNCH_ID:-starter}
      CRUNCH_ID: ${CRUNCH_ID:-starter-challenge}
    volumes:
      - ./base/node/deployment/model-orchestrator-local/data:/app/data
      - ./base/node/deployment/model-orchestrator-local/config:/app/config
      - ./base/challenge:/app/challenge:ro
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: ["sh", "/app/config/docker-entrypoint.sh"]
    command:
      [
        "model-orchestrator",
        "dev",
        "--configuration-file",
        "/app/config/orchestrator.dev.yml",
        "--rebuild",
        "if-code-modified",
      ]
    networks: [backend]

  report-ui:
    build:
      context: ${REPORT_UI_BUILD_CONTEXT:-https://github.com/crunchdao/coordinator-webapp.git}
      dockerfile: ${REPORT_UI_DOCKERFILE:-apps/starter/Dockerfile}
      args:
        NEXT_PUBLIC_API_URL: "${NEXT_PUBLIC_API_URL:-http://report-worker:8000}"
        NEXT_PUBLIC_API_URL_MODEL_ORCHESTRATOR: "${NEXT_PUBLIC_API_URL_MODEL_ORCHESTRATOR:-http://model-orchestrator:8001}"
    container_name: crunch-node-${CRUNCH_ID:-starter}-report-ui
    restart: always
    stop_grace_period: 5s
    ports:
      - "3000:3000"
    volumes:
      - ./base/node/deployment/report-ui/config:/app/config
      - ./base/node/deployment/report-ui/config:/app/apps/${REPORT_UI_APP:-starter}/config
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      report-worker:
        condition: service_healthy
    networks: [frontend, backend]
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

networks:
  frontend:
    driver: bridge
    name: crunch-node-${CRUNCH_ID:-starter}-net
  backend:
    driver: bridge
    internal: true
    name: crunch-node-${CRUNCH_ID:-starter}-backend
  external:
    driver: bridge
    name: crunch-node-${CRUNCH_ID:-starter}-external

volumes:
  postgres_data:
